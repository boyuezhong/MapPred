#!/bin/bash
gitdir=/dl/wuqi/git
dbname=/dl/wuqi/library/nr/nr
ncbidir=$gitdir/blast-2.2.26/bin
execdir=$gitdir/psipred-4.01/bin
execdir2=$gitdir/metapsicov/bin
datadir=$gitdir/psipred-4.01/data
datadir2=$gitdir/metapsicov/data
rootname=$1
cpu=$2
tmproot=psitmp$$$hostid
cp -f $rootname.fasta $tmproot.fasta
echo "Running PSI-BLAST with sequence" $rootname "..."
$ncbidir/blastpgp -a $cpu -b 0 -j 3 -h 0.001 -d $dbname -i $tmproot.fasta -C $tmproot.chk > $tmproot.blast
if [ $? -ne 0 ] ; then
#    cat $tmproot.blast
    echo "FATAL: Error whilst running BLAST blastpgp program - script terminated!"
    exit 1
fi

echo "Predicting secondary structure..."
echo $tmproot.chk > $tmproot.pn
echo $tmproot.fasta > $tmproot.sn
$ncbidir/makemat -P $tmproot
if [ $? -ne 0 ] ; then
    echo "FATAL: Error whilst running BLAST makemat program - script terminated!"
    exit 1
fi

echo Pass1 ...
$execdir/psipred $tmproot.mtx $datadir/weights.dat $datadir/weights.dat2 $datadir/weights.dat3 > $rootname.ss
if [ $? -ne 0 ] ; then
    echo "FATAL: Error whilst running PSIPRED psipred - script terminated!"
    exit 1
fi

echo Pass2 ...

$execdir/psipass2 $datadir/weights_p2.dat 1 1.0 1.0 $rootname.ss2 $rootname.ss > $rootname.horiz
if [ $? -ne 0 ] ;  then
    echo "FATAL: Error whilst running PSIPRED psipass2 - script terminated!"
    exit 1
fi

echo Solvation pass ...
$execdir2/solvpred $tmproot.mtx $datadir2/weights_solv.dat > $rootname.solv
if  [ $? -ne 0 ] ; then
    echo "FATAL: Error whilst running MetaPSICOV solvpred - script terminated!"
    exit 1
fi

echo Cleaning up ...
rm -rf $tmproot.* error.log
echo "Final output files:" $rootname.ss2 $rootname.horiz $rootname.solv
echo "Finished."
